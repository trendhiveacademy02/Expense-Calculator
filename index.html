<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Personal Financial Intelligence Dashboard</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* --- THEME VARIABLES --- */
    :root{
      --bg-body: #f1f5f9;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --border-color: #e2e8f0;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
    }
    [data-theme="dark"]{
      --bg-body: #0f172a;
      --card-bg: #1e293b;
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --border-color: #334155;
      --primary: #3b82f6;
      --primary-hover: #60a5fa;
    }

    /* --- BASE STYLES --- */
    body{ 
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, sans-serif; 
      background: var(--bg-body);
      color: var(--text-main);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* --- COMPONENTS --- */
    .card { 
      background: var(--card-bg); 
      border: 1px solid var(--border-color);
      border-radius: 12px; 
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }
    
    .input-field {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border-color);
      background-color: var(--card-bg); /* Fixed bg for inputs */
      color: var(--text-main);
      font-size: 0.875rem;
      transition: border-color 0.2s;
    }
    .input-field:focus { outline: none; border-color: var(--primary); ring: 2px solid rgba(37, 99, 235, 0.1); }

    .btn { 
      padding: 0.5rem 1.25rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.875rem;
      transition: all 0.2s; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-primary { background-color: var(--primary); color: white; }
    .btn-primary:hover { background-color: var(--primary-hover); }
    .btn-outline { border: 1px solid var(--border-color); color: var(--text-muted); background: transparent; }
    .btn-outline:hover { background-color: var(--bg-body); color: var(--text-main); border-color: var(--text-muted); }

    /* --- UTILS --- */
    .text-muted { color: var(--text-muted); }
    .chart-container { position: relative; height: 300px; width: 100%; }
    .fade-in { animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .hidden { display: none !important; }

    /* --- HEALTH SCORE GAUGE --- */
    .health-ring { 
      width: 120px; height: 120px; border-radius: 50%; 
      background: conic-gradient(var(--primary) var(--progress), var(--border-color) 0deg);
      display: flex; align-items: center; justify-content: center; position: relative;
    }
    .health-inner { 
      width: 100px; height: 100px; background: var(--card-bg); border-radius: 50%; 
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }

    /* --- SCROLL --- */
    .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    [data-theme="dark"] .custom-scroll::-webkit-scrollbar-thumb { background: #475569; }

    /* --- FAB --- */
    .fab {
        position: fixed; bottom: 2rem; right: 2rem; width: 3.5rem; height: 3.5rem;
        background-color: var(--primary); color: white; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2); cursor: pointer; z-index: 50;
        transition: transform 0.2s;
    }
    .fab:hover { transform: scale(1.1); }
  </style>
</head>
<body data-theme="light">

  <!-- AUTH OVERLAY -->
  <div id="auth-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-100 dark:bg-slate-900 transition-colors">
    <div class="card w-full max-w-md p-8 shadow-2xl">
      <div class="text-center mb-6">
        <h1 class="text-3xl font-bold text-slate-800 dark:text-white"><i class="fas fa-brain text-blue-500"></i> Fin.Intel</h1>
        <p class="text-slate-500 text-sm">Personal Financial Intelligence Dashboard</p>
      </div>
      <form id="auth-form" class="space-y-4">
        <input id="auth-email" type="email" placeholder="Email" class="input-field" required />
        <input id="auth-pass" type="password" placeholder="Password" class="input-field" required />
        <button type="submit" class="btn btn-primary w-full py-3">Access Dashboard</button>
        <div id="auth-error" class="text-red-500 text-xs text-center hidden"></div>
        <div class="text-center text-xs text-blue-500 cursor-pointer hover:underline" id="toggle-auth-mode">Need an account? Sign Up</div>
      </form>
    </div>
  </div>

  <!-- APP CONTAINER -->
  <div id="app-container" class="max-w-7xl mx-auto p-4 md:p-6 hidden pb-24">
    
    <!-- HEADER -->
    <header class="flex flex-col md:flex-row items-center justify-between mb-6 gap-4 fade-in">
      <div>
        <h1 class="text-2xl font-bold tracking-tight flex items-center gap-2">
          <i class="fas fa-layer-group text-blue-600"></i> Financial Intelligence
        </h1>
        <p class="text-xs text-muted">Advanced Analytics & Predictive Modeling</p>
      </div>
      <div class="flex gap-2">
        <button id="themeToggle" class="btn btn-outline py-1.5 px-3"><i class="fas fa-moon"></i></button>
        <button id="btnSignOut" class="btn btn-outline py-1.5 px-3 text-red-500 border-red-200">Logout</button>
      </div>
    </header>

    <!-- SECTION 0: QUICK STATS (ADDED) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 fade-in">
        <div class="card p-4 flex items-center justify-between border-l-4 border-l-green-500">
            <div>
                <p class="text-[10px] font-bold text-muted uppercase tracking-wider">Total Income</p>
                <h3 id="dispIncome" class="text-2xl font-bold text-green-600">₹0</h3>
            </div>
            <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600">
                <i class="fas fa-arrow-down"></i>
            </div>
        </div>
        <div class="card p-4 flex items-center justify-between border-l-4 border-l-red-500">
            <div>
                <p class="text-[10px] font-bold text-muted uppercase tracking-wider">Total Expense</p>
                <h3 id="dispExpense" class="text-2xl font-bold text-red-600">₹0</h3>
            </div>
            <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-600">
                <i class="fas fa-arrow-up"></i>
            </div>
        </div>
        <div class="card p-4 flex items-center justify-between border-l-4 border-l-blue-500">
            <div>
                <p class="text-[10px] font-bold text-muted uppercase tracking-wider">Net Balance</p>
                <h3 id="dispBalance" class="text-2xl font-bold text-blue-600">₹0</h3>
            </div>
            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                <i class="fas fa-wallet"></i>
            </div>
        </div>
    </div>

    <!-- SECTION 1: HEALTH & PREDICTION -->
    <div class="grid grid-cols-1 md:grid-cols-12 gap-6 mb-6">
        <!-- Health Score Card -->
        <div class="card p-6 md:col-span-4 flex flex-col items-center justify-center text-center fade-in bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-900">
            <h3 class="text-xs font-bold uppercase text-muted mb-4 tracking-wider">Financial Health Score</h3>
            <div class="health-ring mb-4" id="healthRing" style="--progress: 0deg">
                <div class="health-inner">
                    <span id="healthScore" class="text-3xl font-black text-slate-800 dark:text-white">--</span>
                    <span id="healthLabel" class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500">Calculating</span>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-2 w-full text-xs mt-2 border-t pt-4 dark:border-slate-700">
                <div>
                    <div class="text-muted mb-1">Runway</div>
                    <div id="metricRunway" class="font-bold text-slate-700 dark:text-slate-200">-- Mo</div>
                </div>
                <div>
                    <div class="text-muted mb-1">Savings Rate</div>
                    <div id="metricSavingsRate" class="font-bold text-green-600">--%</div>
                </div>
                <div>
                    <div class="text-muted mb-1">Volatility</div>
                    <div id="metricVolatility" class="font-bold text-amber-600">--</div>
                </div>
            </div>
        </div>

        <!-- Predictive Analytics -->
        <div class="card p-6 md:col-span-8 fade-in">
            <h3 class="text-xs font-bold uppercase text-muted mb-4 flex justify-between items-center">
                <span><i class="fas fa-crystal-ball text-purple-500 mr-1"></i> AI-Free Insights Engine</span>
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Budget Prediction -->
                <div class="space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-muted">Month Progress</span>
                        <span id="monthProgressTxt" class="font-mono font-bold">0%</span>
                    </div>
                    <div class="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-2">
                        <div id="monthProgressBar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                    
                    <div class="p-3 rounded-lg bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 mt-2">
                        <div class="text-xs text-muted uppercase">Predicted End-of-Month Expense</div>
                        <div class="flex items-end gap-2 mt-1">
                            <span id="predTotal" class="text-xl font-bold text-slate-800 dark:text-white">₹0</span>
                            <span id="predDiff" class="text-xs font-bold mb-1"></span>
                        </div>
                        <div class="text-[10px] text-muted mt-1">Based on daily burn rate of <span id="burnRate" class="font-mono">₹0</span></div>
                    </div>
                </div>

                <!-- Insights List -->
                <div class="h-full max-h-[140px] overflow-y-auto custom-scroll pr-1">
                    <ul id="insightsList" class="space-y-2 text-xs">
                        <li class="p-2 bg-slate-50 dark:bg-slate-800 rounded border-l-2 border-slate-300">Initializing Intelligence Engine...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- SECTION 2: FILTERS (REDESIGNED) -->
    <div class="card p-5 mb-6 fade-in">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <!-- View Mode -->
            <div>
                <label class="text-[10px] font-bold text-muted uppercase tracking-wider mb-2 block">View Mode</label>
                <select id="viewMode" class="input-field py-2 text-sm font-medium cursor-pointer">
                    <option value="daily">Daily</option>
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly</option>
                    <option value="all">All Time</option>
                </select>
            </div>
            <!-- Year -->
            <div>
                <label class="text-[10px] font-bold text-muted uppercase tracking-wider mb-2 block">Year</label>
                <select id="filterYear" class="input-field py-2 text-sm font-medium cursor-pointer"></select>
            </div>
            <!-- Month -->
            <div>
                <label class="text-[10px] font-bold text-muted uppercase tracking-wider mb-2 block">Month</label>
                <select id="filterMonth" class="input-field py-2 text-sm font-medium cursor-pointer"></select>
            </div>
            <!-- Day -->
            <div>
                <label class="text-[10px] font-bold text-muted uppercase tracking-wider mb-2 block">Day</label>
                <select id="filterDay" class="input-field py-2 text-sm font-medium cursor-pointer">
                    <option value="all">All Days</option>
                </select>
            </div>
        </div>
        
        <div class="flex flex-col md:flex-row gap-3 items-center">
            <div class="relative flex-1 w-full">
                <i class="fas fa-search absolute left-3 top-3.5 text-slate-400 text-sm"></i>
                <input id="filterCategory" type="text" placeholder="Filter Category..." class="input-field pl-10 py-2.5 text-sm" />
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                 <button id="applyFilter" class="btn btn-primary px-6 shadow-md hover:shadow-lg">Apply</button>
                 <button id="resetFilter" class="btn btn-outline px-6">Reset</button>
            </div>
        </div>
    </div>

    <!-- SECTION 3: CHARTS (UPDATED VISUALS) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="card p-5 fade-in">
            <h3 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-4 flex items-center gap-2">
                <i class="fas fa-chart-bar text-blue-500"></i> Income vs Expense
            </h3>
            <div class="chart-container">
                <canvas id="barChart"></canvas>
            </div>
        </div>
        <div class="card p-5 fade-in">
            <h3 class="text-sm font-bold text-slate-700 dark:text-slate-300 mb-4 flex items-center gap-2">
                <i class="fas fa-chart-pie text-purple-500"></i> Spending by Category
            </h3>
            <div class="chart-container">
                <canvas id="pieChart"></canvas>
            </div>
        </div>
    </div>

    <!-- SECTION 4: DATA ENTRY & LIST -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Add Entry Card -->
        <div class="lg:col-span-1 space-y-6">
            <div class="card p-5 fade-in" id="addEntryCard">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-sm" id="formTitle">New Transaction</h3>
                    <button id="btnClear" class="text-xs text-blue-500 hover:text-blue-700 font-medium">Clear All</button>
                </div>
                <div class="space-y-3">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-muted uppercase">Date</label>
                        <input id="inpDate" type="date" class="input-field" />
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-muted uppercase">Type</label>
                            <select id="inpType" class="input-field cursor-pointer">
                                <option value="expense">Expense</option>
                                <option value="earning">Income</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-muted uppercase">Source</label>
                            <select id="inpSource" class="input-field cursor-pointer">
                                <option value="UPI">UPI</option>
                                <option value="Cash">Cash</option>
                                <option value="Card">Card</option>
                                <option value="Bank">Bank Transfer</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-muted uppercase">Category</label>
                        <input id="inpCategory" type="text" list="catList" placeholder="e.g. Food, Fuel..." class="input-field" />
                        <datalist id="catList"></datalist>
                    </div>
                    
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-muted uppercase">Amount</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2 text-slate-400 font-bold">₹</span>
                            <input id="inpAmount" type="number" step="0.01" placeholder="0.00" class="input-field pl-8 font-mono font-bold" />
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-muted uppercase">Note</label>
                        <input id="inpNote" type="text" placeholder="Description..." class="input-field" />
                    </div>
                    
                    <div class="flex items-center gap-2 text-xs py-2">
                        <input id="inpRecurring" type="checkbox" class="accent-blue-500 w-4 h-4 cursor-pointer" />
                        <label for="inpRecurring" class="text-slate-600 dark:text-slate-300 cursor-pointer">Recurring Monthly?</label>
                    </div>

                    <button id="btnAdd" class="btn btn-primary w-full shadow-md">Add Transaction</button>
                    <div id="dupWarn" class="hidden text-[10px] text-amber-600 bg-amber-50 p-2 rounded text-center border border-amber-200">
                        <i class="fas fa-exclamation-triangle"></i> Possible duplicate detected
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction List -->
        <div class="lg:col-span-2 card flex flex-col fade-in overflow-hidden h-[600px]">
            <div class="p-4 border-b dark:border-slate-700 flex flex-col sm:flex-row justify-between items-center bg-slate-50 dark:bg-slate-800/50 gap-3">
                <h3 class="font-bold text-sm">Transactions</h3>
                
                <div class="flex items-center gap-2">
                    <label class="text-[10px] font-bold text-muted uppercase">Sort By:</label>
                    <select id="sortBy" class="input-field py-1 px-2 text-xs w-auto cursor-pointer">
                        <option value="date-desc">Date (Newest)</option>
                        <option value="date-asc">Date (Oldest)</option>
                        <option value="amt-high">Amount (High)</option>
                        <option value="amt-low">Amount (Low)</option>
                    </select>
                </div>
            </div>
            <div class="flex-1 overflow-auto custom-scroll p-0">
                <table class="w-full text-left text-xs border-collapse">
                    <thead class="sticky top-0 bg-white dark:bg-slate-800 shadow-sm z-10 text-muted uppercase tracking-wider font-semibold">
                        <tr>
                            <th class="p-3">Date</th>
                            <th class="p-3">Details</th>
                            <th class="p-3 text-right">Amount</th>
                            <th class="p-3 text-right">Bal (Mo)</th>
                            <th class="p-3 text-center">Act</th>
                        </tr>
                    </thead>
                    <tbody id="txTableBody" class="divide-y divide-slate-100 dark:divide-slate-700">
                        <!-- JS Rendered -->
                    </tbody>
                </table>
            </div>
            <!-- Pagination -->
            <div class="p-3 border-t dark:border-slate-700 flex justify-between items-center text-xs bg-slate-50 dark:bg-slate-800/30">
                 <button id="pagePrev" class="btn btn-outline py-1 px-3 bg-white dark:bg-slate-800">Prev</button>
                 <span id="pageInd" class="text-muted font-medium">Page 1</span>
                 <button id="pageNext" class="btn btn-outline py-1 px-3 bg-white dark:bg-slate-800">Next</button>
            </div>
        </div>
    </div>
    
  </div>

  <!-- FAB -->
  <div id="fab" class="fab md:hidden"><i class="fas fa-plus text-xl"></i></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, addDoc, deleteDoc, updateDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBSE8QWjz_4Cf5Vlm7CIz1uCjFnF2qtpYk",
  authDomain: "expensecalculator-59d9f.firebaseapp.com",
  databaseURL: "https://expensecalculator-59d9f-default-rtdb.firebaseio.com",
  projectId: "expensecalculator-59d9f",
  storageBucket: "expensecalculator-59d9f.firebasestorage.app",
  messagingSenderId: "784723201241",
  appId: "1:784723201241:web:c29a9cb222e1a9663d82c8",
  measurementId: "G-NG0MG3DJBN"
};

/* --- CORE STATE --- */
let app, auth, db, userId;
let rawEntries = [];
let processedEntries = []; 
let settings = { budget: 20000, darkMode: false };
let currentPage = 1, pageSize = 20;
let unsubscribe = null;
let editingId = null;

const $ = (id) => document.getElementById(id);
const formatCur = (n) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(n);

/* --- INIT --- */
async function init() {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    
    // Auth Listener
    onAuthStateChanged(auth, async (user) => {
        if(user) {
            userId = user.uid;
            $("auth-container").classList.add("hidden");
            $("app-container").classList.remove("hidden");
            loadSettings();
            subscribeData();
            initDateFilters();
        } else {
            $("auth-container").classList.remove("hidden");
            $("app-container").classList.add("hidden");
            if(unsubscribe) unsubscribe();
            rawEntries = [];
        }
    });

    // Event Listeners
    $("themeToggle").onclick = toggleTheme;
    $("btnSignOut").onclick = () => signOut(auth);
    $("auth-form").onsubmit = handleAuth;
    $("toggle-auth-mode").onclick = toggleAuthMode;
    $("btnAdd").onclick = addEntry;
    $("btnClear").onclick = clearForm;
    $("applyFilter").onclick = renderAll;
    $("resetFilter").onclick = resetFilters;
    $("pagePrev").onclick = () => changePage(-1);
    $("pageNext").onclick = () => changePage(1);
    $("fab").onclick = () => $("addEntryCard").scrollIntoView({ behavior: 'smooth' });
    $("inpAmount").oninput = checkDuplicates;
    $("sortBy").onchange = renderAll;
    $("inpDate").value = new Date().toISOString().split('T')[0];
    
    // Auto-update days when month/year changes
    $("filterYear").onchange = initDayOptions;
    $("filterMonth").onchange = initDayOptions;
}

function initDateFilters() {
    const today = new Date();
    const ySel = $("filterYear");
    const mSel = $("filterMonth");
    
    // Populate Years
    const currentY = today.getFullYear();
    ySel.innerHTML = "";
    for(let i=currentY; i>=currentY-5; i--) {
        const o = document.createElement("option"); o.value = i; o.innerText = i;
        ySel.appendChild(o);
    }
    
    // Populate Months
    mSel.innerHTML = "";
    const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    months.forEach((m, i) => {
        const o = document.createElement("option"); o.value = i+1; o.innerText = m;
        if(i === today.getMonth()) o.selected = true;
        mSel.appendChild(o);
    });
    
    initDayOptions();
}

function initDayOptions() {
    const dSel = $("filterDay");
    const y = parseInt($("filterYear").value);
    const m = parseInt($("filterMonth").value);
    const daysInMonth = new Date(y, m, 0).getDate();
    
    const prevVal = dSel.value;
    dSel.innerHTML = '<option value="all">All Days</option>';
    for(let i=1; i<=daysInMonth; i++) {
        const o = document.createElement("option"); o.value = i; o.innerText = i;
        dSel.appendChild(o);
    }
    if(prevVal !== 'all' && parseInt(prevVal) <= daysInMonth) dSel.value = prevVal;
}

function resetFilters() {
    $("viewMode").value = "daily";
    $("filterCategory").value = "";
    initDateFilters();
    renderAll();
}

/* --- FINANCIAL INTELLIGENCE & DATA PROCESS --- */

function processData(entries) {
    // 1. Sort by Date Ascending + Created At Ascending for correct chronological balance calc
    let sorted = [...entries].sort((a,b) => {
        const diff = new Date(a.date) - new Date(b.date);
        if(diff !== 0) return diff;
        return (new Date(a.createdAt||0)) - (new Date(b.createdAt||0));
    });
    
    // 2. Calculate Monthly Running Balance (Resets to 0 each month)
    let runningBal = 0;
    let currentKey = "";
    let incomeSeen = false; // Flag for "Stay 0" logic
    
    processedEntries = sorted.map(e => {
        const d = new Date(e.date);
        const key = `${d.getFullYear()}-${d.getMonth()}`; // Group by month
        
        if(key !== currentKey) {
            currentKey = key;
            runningBal = 0; // RESET BALANCE
            incomeSeen = false; // Reset income flag
        }
        
        const amt = parseFloat(e.amount);
        if(e.type === 'earning') {
            runningBal += amt;
            incomeSeen = true; // Income recorded!
        } else {
            runningBal -= amt;
        }
        
        // LOGIC: If we haven't seen income yet this month, force visual balance to 0 (or prevent negative)
        let displayBal = runningBal;
        if (!incomeSeen && runningBal < 0) {
            displayBal = 0;
        }
        
        return { ...e, balance: displayBal, timestamp: d.getTime() };
    });
}

function calculateHealth(entries) {
    if(entries.length < 5) return { score: 0, label: "Need Data", savingsRate: 0, runway: 0, volatility: "Low", projected: 0, burnRate: 0, monthExp: 0 };
    
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();

    const recent = entries.filter(e => (now - new Date(e.date))/(1000*60*60*24) <= 30);
    const income = recent.filter(e => e.type === 'earning').reduce((s,e) => s+parseFloat(e.amount),0);
    const expense = recent.filter(e => e.type === 'expense').reduce((s,e) => s+parseFloat(e.amount),0);
    
    let savingsRate = 0;
    if(income > 0) savingsRate = ((income - expense) / income) * 100;
    
    const monthExp = entries.filter(e => {
        const d = new Date(e.date);
        return d.getMonth() === currentMonth && d.getFullYear() === currentYear && e.type === 'expense';
    }).reduce((s,e) => s + parseFloat(e.amount), 0);
    
    const budget = settings.budget || 20000;
    const projected = (monthExp / (now.getDate() || 1)) * new Date(currentYear, currentMonth + 1, 0).getDate();
    
    const score = Math.min(100, Math.max(0, Math.round(savingsRate + (budget > projected ? 20 : 0))));
    
    return {
        score,
        label: score > 70 ? "Excellent" : score > 40 ? "Stable" : "Critical",
        savingsRate: savingsRate.toFixed(0),
        runway: ((processedEntries[processedEntries.length-1]?.balance || 0) / (expense || 1)).toFixed(1),
        volatility: "Med",
        projected,
        monthExp,
        burnRate: (expense/30).toFixed(0)
    };
}

/* --- RENDER LOGIC --- */
function renderAll() {
    processData(rawEntries);
    
    const health = calculateHealth(rawEntries);
    updateHealthUI(health);
    
    // Filter
    const mode = $("viewMode").value;
    const fYear = parseInt($("filterYear").value);
    const fMonth = parseInt($("filterMonth").value);
    const fDay = $("filterDay").value;
    const fCat = $("filterCategory").value.toLowerCase();
    
    let filtered = processedEntries.filter(e => {
        const d = new Date(e.date);
        const matchCat = e.category.toLowerCase().includes(fCat) || e.source?.toLowerCase().includes(fCat);
        if(!matchCat) return false;

        if (mode === 'all') return true;
        if (d.getFullYear() !== fYear) return false;
        if (mode === 'yearly') return true;
        if ((d.getMonth() + 1) !== fMonth) return false;
        if (mode === 'monthly') return true;
        if (fDay !== 'all' && d.getDate() !== parseInt(fDay)) return false;
        return true;
    });

    // Sorting
    const sortMode = $("sortBy").value;
    filtered.sort((a,b) => {
        if(sortMode === 'date-asc') {
            const diff = a.timestamp - b.timestamp;
            if(diff !== 0) return diff;
            // Stable sort: Created At Ascending (Oldest first)
            return (new Date(a.createdAt||0)) - (new Date(b.createdAt||0));
        }
        if(sortMode === 'date-desc') {
            const diff = b.timestamp - a.timestamp;
            if(diff !== 0) return diff;
            // Stable sort: Created At Descending (Newest first - "New data on top")
            return (new Date(b.createdAt||0)) - (new Date(a.createdAt||0));
        }
        if(sortMode === 'amt-high') return b.amount - a.amount;
        if(sortMode === 'amt-low') return a.amount - b.amount;
    });

    // Pagination
    const start = (currentPage - 1) * pageSize;
    const paged = filtered.slice(start, start + pageSize);
    
    renderTable(paged);
    updateCharts(filtered, fYear, fMonth);
    updateQuickStats(filtered);

    $("pageInd").innerText = `Page ${currentPage} of ${Math.ceil(filtered.length/pageSize) || 1}`;
}

function updateQuickStats(list) {
    const inc = list.filter(e => e.type === 'earning').reduce((acc, curr) => acc + parseFloat(curr.amount), 0);
    const exp = list.filter(e => e.type === 'expense').reduce((acc, curr) => acc + parseFloat(curr.amount), 0);
    const bal = inc - exp;

    $("dispIncome").innerText = formatCur(inc);
    $("dispExpense").innerText = formatCur(exp);
    $("dispBalance").innerText = formatCur(bal);
}

function updateHealthUI(health) {
    $("healthScore").innerText = health.score;
    $("healthLabel").innerText = health.label;
    $("healthRing").style.setProperty('--progress', `${health.score * 3.6}deg`);
    $("metricRunway").innerText = `${health.runway} Mo`;
    $("metricSavingsRate").innerText = `${health.savingsRate}%`;
    
    const budget = settings.budget || 20000;
    const pct = Math.min(100, (health.monthExp / budget) * 100);
    $("monthProgressBar").style.width = `${pct}%`;
    $("monthProgressTxt").innerText = `${pct.toFixed(0)}%`;
    $("predTotal").innerText = formatCur(health.projected);
    $("burnRate").innerText = formatCur(health.burnRate);
}

function renderTable(list) {
    const tbody = $("txTableBody");
    tbody.innerHTML = "";
    
    list.forEach(e => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors border-b dark:border-slate-800";
        const isExp = e.type === 'expense';
        
        tr.innerHTML = `
            <td class="p-3 whitespace-nowrap text-slate-600 dark:text-slate-300">
                <div class="font-bold">${e.date}</div>
                <div class="text-[10px] uppercase text-muted">${e.source || 'CASH'}</div>
            </td>
            <td class="p-3">
                <div class="font-bold text-slate-800 dark:text-white">${e.category}</div>
                <div class="text-[10px] text-muted truncate max-w-[120px]">${e.note || ''}</div>
            </td>
            <td class="p-3 text-right font-bold ${isExp ? 'text-red-500' : 'text-green-600'}">
                ${isExp ? '-' : '+'}${formatCur(e.amount)}
            </td>
            <td class="p-3 text-right font-mono text-muted text-[10px]">
                ${formatCur(e.balance)}
            </td>
            <td class="p-3 text-center flex justify-center gap-2">
                <button class="text-blue-500 hover:text-blue-700 p-1" title="Edit" onclick="window.editTx('${e.id}')"><i class="fas fa-edit"></i></button>
                <button class="text-slate-400 hover:text-red-500 p-1" title="Delete" onclick="window.delTx('${e.id}')"><i class="fas fa-trash"></i></button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

/* --- CHARTS --- */
let barChartInst = null;
let pieChartInst = null;

function updateCharts(list, year, month) {
    // 1. Income vs Expense (Grouped Bar by Day) - Per user screenshot
    // Filter list for the selected month to show daily bars
    const daysInMonth = new Date(year, month, 0).getDate();
    const days = Array.from({length: daysInMonth}, (_, i) => i + 1);
    
    const dailyInc = new Array(daysInMonth).fill(0);
    const dailyExp = new Array(daysInMonth).fill(0);

    list.forEach(e => {
        const d = new Date(e.date);
        // Only process if it matches the filter (filtered list already handles this mostly, but double check date range logic if viewing 'All')
        // Assuming user wants to see the breakdown of the CURRENT view
        if(d.getMonth() + 1 === month && d.getFullYear() === year) {
             const dayIdx = d.getDate() - 1;
             if(e.type === 'earning') dailyInc[dayIdx] += parseFloat(e.amount);
             else dailyExp[dayIdx] += parseFloat(e.amount);
        }
    });

    const barCtx = $("barChart").getContext("2d");
    if(barChartInst) barChartInst.destroy();
    barChartInst = new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: days, // 1, 2, 3...
            datasets: [
                { label: 'Income', data: dailyInc, backgroundColor: '#10b981', borderRadius: 4 }, // Green
                { label: 'Expense', data: dailyExp, backgroundColor: '#ef4444', borderRadius: 4 } // Red
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: { 
                x: { grid: { display: false } },
                y: { beginAtZero: true, border: { dash: [4, 4] } }
            }
        }
    });

    // 2. Spending by Category (Doughnut with Legend Right)
    const catMap = {};
    list.filter(e => e.type === 'expense').forEach(e => catMap[e.category] = (catMap[e.category]||0) + parseFloat(e.amount));
    const sortedCats = Object.entries(catMap).sort((a,b)=>b[1]-a[1]); // Top categories
    
    // Vibrant colors matching screenshot vibe
    const palette = ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ef4444', '#14b8a6', '#f97316'];

    const pieCtx = $("pieChart").getContext("2d");
    if(pieChartInst) pieChartInst.destroy();
    pieChartInst = new Chart(pieCtx, {
        type: 'doughnut',
        data: {
            labels: sortedCats.map(c=>c[0]),
            datasets: [{
                data: sortedCats.map(c=>c[1]),
                backgroundColor: palette,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: {
                legend: {
                    position: 'right', // Legend on right as requested
                    labels: { usePointStyle: true, boxWidth: 8, font: { size: 10 } }
                }
            }
        }
    });
}

/* --- FIREBASE OPS --- */
function subscribeData() {
    unsubscribe = onSnapshot(collection(db, `users/${userId}/entries`), (snap) => {
        rawEntries = [];
        snap.forEach(d => rawEntries.push({ id: d.id, ...d.data() }));
        renderAll();
    });
}

async function addEntry() {
    const data = {
        date: $("inpDate").value,
        type: $("inpType").value,
        category: $("inpCategory").value,
        amount: parseFloat($("inpAmount").value),
        note: $("inpNote").value,
        source: $("inpSource").value,
        recurring: $("inpRecurring").checked
    };
    
    if(!data.date || !data.amount) return alert("Date and Amount required");
    
    $("btnAdd").disabled = true;
    try {
        if(editingId) {
            await updateDoc(doc(db, `users/${userId}/entries`, editingId), data);
            alert("Updated successfully");
        } else {
            data.createdAt = new Date().toISOString();
            await addDoc(collection(db, `users/${userId}/entries`), data);
        }
        clearForm();
    } catch(e) { console.error(e); alert("Error saving"); }
    $("btnAdd").disabled = false;
}

window.editTx = (id) => {
    const e = rawEntries.find(x => x.id === id);
    if(!e) return;
    
    editingId = id;
    $("inpDate").value = e.date;
    $("inpType").value = e.type;
    $("inpCategory").value = e.category;
    $("inpAmount").value = e.amount;
    $("inpNote").value = e.note || "";
    $("inpSource").value = e.source || "Cash";
    $("inpRecurring").checked = !!e.recurring;
    
    $("formTitle").innerText = "Edit Transaction";
    $("btnAdd").innerText = "Update Transaction";
    $("btnAdd").classList.replace("btn-primary", "bg-orange-500");
    $("btnAdd").classList.add("text-white");
    
    $("addEntryCard").scrollIntoView({ behavior: 'smooth' });
};

window.delTx = async (id) => {
    if(confirm("Delete this transaction?")) await deleteDoc(doc(db, `users/${userId}/entries`, id));
};

function clearForm() {
    editingId = null;
    $("inpAmount").value = ""; $("inpNote").value = ""; $("inpCategory").value = "";
    $("formTitle").innerText = "New Transaction";
    $("btnAdd").innerText = "Add Transaction";
    $("btnAdd").classList.remove("bg-orange-500");
    $("btnAdd").classList.add("btn-primary");
    $("dupWarn").classList.add("hidden");
}

function checkDuplicates() {
    if(editingId) return;
    const amt = parseFloat($("inpAmount").value);
    const date = $("inpDate").value;
    const dup = rawEntries.find(e => e.amount == amt && e.date === date);
    if(dup) $("dupWarn").classList.remove("hidden");
    else $("dupWarn").classList.add("hidden");
}

/* --- AUTH UI HANDLERS --- */
let isLogin = true;
function toggleAuthMode() {
    isLogin = !isLogin;
    $("toggle-auth-mode").innerText = isLogin ? "Need an account? Sign Up" : "Have an account? Login";
    $("auth-form").querySelector("button").innerText = isLogin ? "Access Dashboard" : "Create Dashboard";
}
async function handleAuth(e) {
    e.preventDefault();
    const email = $("auth-email").value;
    const pass = $("auth-pass").value;
    const errEl = $("auth-error");
    
    try {
        if(isLogin) await signInWithEmailAndPassword(auth, email, pass);
        else await createUserWithEmailAndPassword(auth, email, pass);
    } catch(err) {
        errEl.innerText = err.message;
        errEl.classList.remove("hidden");
    }
}

/* --- SETTINGS & HELPERS --- */
async function loadSettings() {
    try {
        const snap = await getDoc(doc(db, `users/${userId}/settings/config`));
        if(snap.exists()) {
            settings = { ...settings, ...snap.data() };
            if(settings.darkMode) document.body.setAttribute("data-theme", "dark");
        }
    } catch(e) {}
}

function toggleTheme() {
    const isDark = document.body.getAttribute("data-theme") === "dark";
    document.body.setAttribute("data-theme", isDark ? "light" : "dark");
    settings.darkMode = !isDark;
    setDoc(doc(db, `users/${userId}/settings/config`), settings);
}

function changePage(dir) {
    const max = Math.ceil(processedEntries.length / pageSize) || 1;
    if(currentPage + dir > 0 && currentPage + dir <= max) {
        currentPage += dir;
        renderAll();
    }
}

init();

</script>
</body>
</html>
